## Claude Code 向けプロンプト：AMATELUS 市民向けスマホウォレット PoC 開発依頼

### プロジェクト概要

AMATELUSは、自己主権型アイデンティティ（SSI）とゼロ知識証明（ZKP）を核とする未来の都市OSアーキテクチャのプロトコルです。本プロジェクトでは、AMATELUSプロトコルにおける市民（Holder）向けのウォレットアプリケーションの概念実証（PoC）を開発します。

主な目的は、現代のスマートフォンブラウザ環境におけるDID/VC/ZKPの運用フローと計算時間（特にZKP生成）の検証です。行政窓口での運用を想定し、QRコードリーダーと小型ディスプレイを介した2段階のQRコードスキャンによる本人認証と、大容量VCの安全な受け渡しフローを実装します。**市民は複数のDIDを生成・管理し、用途に応じて選択して利用できる**ことを前提とします。HSMなどによる秘密鍵の安全な保管はPoCのスコープ外とし、開発の簡便性のため`localStorage`に保存します。

### 技術スタック

- **フロントエンド:** Next.js, React, TypeScript
- **スタイル:** CSSモジュール
- **暗号ライブラリ:**
  - DID/公開鍵生成、署名/検証: `tweetnacl` (Ed25519) または Web Crypto API
  - ZKP: `snarkjs` および `circom` (WASM版)
- **データ永続化:** `localStorage`
- **QRコード:** `qrcode.react` (生成), `html5-qrcode` (読み取り、または簡易なカメラアクセスAPI)

### 開発範囲（MVP）

AMATELUS 市民向けスマホウォレットのMVP（Minimum Viable Product）として、以下の機能を実装します。

#### 1. DID（分散型識別子）管理

- **DID生成:**
  - ユーザーがウォレットを初めて開いた際に、**最初のDIDを自動生成**する機能を提供。
  - 加えて、**ユーザーが任意で新しいDIDを追加生成できる**ボタン/機能を提供。
  - 各DID生成時には、`Ed25519` 秘密鍵/公開鍵ペアを生成し、公開鍵と特定の固定テンプレート（AMATELUS最小DIDドキュメントの静的部分）を結合した文字列の**SHA3-512ハッシュ値**を計算することで、DIDの`method-specific-id`（PQCハッシュの模倣）を生成します。
  - 生成された**各DIDの**秘密鍵、公開鍵、および再構築された完全なDIDドキュメントのJSON形式を、**DIDごとに一意のキーで`localStorage`に保存**します（例: `amatelus_dids: [ { did: "...", privKey: "...", pubKey: "...", didDoc: {...} }, ... ]` のような配列形式）。
- **DID一覧/選択:**
  - ウォレットトップ画面で、**生成済みの全てのDIDを一覧表示**するUIを提供。
  - ユーザーが一覧から任意のDIDを選択し、**そのDIDをアクティブなDIDとして設定できる**機能を提供。アクティブなDIDは、以降のQRコード提示やVC管理の操作で自動的に使用されます。

#### 2. 公開鍵配列提示用QRコード生成

- **QRコードデータ構造:** **現在選択されているアクティブなDIDに紐づく`[バージョン番号, 公開鍵]`** の配列形式でQRコードデータを生成します。
  - `バージョン番号 (v)`: AMATELUS DIDドキュメントの静的テンプレートを一意に指定する整数（例: `1`）。このバージョン番号に基づき、検証者は公開鍵のタイプ（例: Ed25519）を含むDIDドキュメントの残りの部分を正確に再構築できるものとします。
  - `公開鍵 (pubKey)`: アクティブなDIDを制御する秘密鍵に対応する公開鍵データ（Base58Btcエンコード、`z`接頭辞付き）。
- **UI:** ユーザーが「本人確認」ボタンなどを押すと、上記データをエンコードした**1つ目のQRコード**をスマホ画面に大きく表示します。

#### 3. 秘密鍵所有権確認フロー（2段階QRスキャン）

自治体窓口での運用を想定し、以下のフローをウォレットアプリ側で実装します。

1.  **Nonce QRコード読み取り:**
    - 1つ目のQRコード提示後、ウォレットアプリは**QRコードスキャナーモード**に移行し、自治体側の小型ディスプレイに表示されるNonceのQRコードを読み取る準備をします。
    - 読み取りが成功すると、アプリ内にNonce文字列が表示されます。
2.  **Nonceへの署名生成:**
    - 読み取ったNonceを、**現在アクティブなDIDに紐づく秘密鍵**で**デジタル署名**します。
    - **リプレイ攻撃対策:** 署名対象のデータにこのNonceを含めることで、生成される署名が特定のセッションに紐づくようにします。
3.  **署名済みNonce QRコード生成と提示:**
    - 生成された署名データをエンコードした**2つ目のQRコード**をスマホ画面に大きく表示します。
    - このQRコードは、自治体側が再度スキャンして署名検証を行うためのものです。

#### 4. VC（Verifiable Credentials）管理

- **VC手動追加:** VC発行者（Issuer）からのVCを模擬的に追加できる機能。ユーザーがJSON形式のVCテキストを貼り付けるためのテキストエリアと登録ボタンを提供。
  - 追加されたVCは、**現在アクティブなDIDに紐づけて`localStorage`に保存**します（例: `amatelus_vcs: { "did1": [...vc_list_for_did1], "did2": [...vc_list_for_did2] }` のような構造）。
- **VC一覧表示:** **アクティブなDIDに紐づくVCのみを一覧表示**し、詳細を確認できるUI。

#### 5. 大容量VCの安全な発行フロー（分割VCの読み取りと再構築）

自治体から大容量VCを受け取るための機能を実装します。

1.  **VC全体ハッシュQRコード読み取り:**
    - ウォレットアプリ内に「VC受け取り」機能を提供。この機能を選択すると、QRコードスキャナーモードに移行し、自治体側が表示する**最初のQRコード（VC全体のハッシュ値と分割数情報を含む）** を読み取る。
    - 読み取り後、アプリはVC受け取りの進捗UIを表示し、各パーツを待機する状態になる。
2.  **VCパーツQRコードの順不同読み取り:**
    - アプリはQRコードスキャナーモードを維持し、自治体側が順次表示するVCパーツのQRコードを連続して読み取ります。
      - 各VCパーツQRコードは、`[VC_Part_Index, VC_Part_Data]` の配列形式でエンコードされているものとします。
    - 読み取ったパーツはメモリ上に一時保存し、インデックス情報に基づいてVCの再構築を進めます。
    - **UI支援:** アプリは「読み取り済み N / 総パーツ数 M」といった進捗表示を行い、ユーザーが全てのパーツを読み取れたかを確認できるようにします。
3.  **VC全体の再構築と検証:**
    - 全てのVCパーツが読み取られ、VCが完全に再構築されると、ウォレットアプリは再構築されたVC全体のハッシュを計算します。
    - この計算結果が、ステップ1で最初に読み取った**VC全体のハッシュ値と一致するか**を検証します。
    - **検証成功:** VCが完全に、かつ改ざんされずに受け取られたことをユーザーに通知し、**現在アクティブなDIDに紐づけて`localStorage`に保存**します。

#### 6. ZKP（ゼロ知識証明）の生成と提示

- **ZKP回路の組み込み:**
  - ZKP回路は、`circom`で記述し、`snarkjs`で生成したWASM/zkeyファイルをNext.jsプロジェクト内にバンドル（ハードコード）。
  - **主要なZKP回路:** **「20歳以上であることの証明」**
    - **アクティブなDIDに紐づくVC**内の生年月日（`birthDate`プロパティを想定）と、ZKP生成時の現在日付を用いて「20歳以上であること」を証明。
    - **リプレイ攻撃対策:** ZKP生成時に、Verifierから提供される**チャレンジ文字列（Nonce）** をZKP回路の入力に含めます。
    - 回路の入力は `{ "birthDate": private, "currentDate": public, "nonce": public }` となります。
- **ZKP生成UI:**
  - ユーザーが**アクティブなDIDに紐づく**対象のVC（例: 住民データVC）を選択し、「20歳以上を証明」ボタンをクリックすると、ZKP生成プロセスを開始。
  - **チャレンジ文字列入力欄:** 検証者（Verifier）から受け取るチャレンジ文字列を入力するテキストフィールド。
  - ブラウザがアクティブな状態でのZKP生成を促すメッセージ表示。
  - ZKP生成中はローディング表示を行い、完了後に生成されたZKP（JSON形式）を画面に表示。生成時間も計測し表示。
- **ZKP提示UI:**
  - 生成されたZKPをQRコードとして表示する機能。
  - 連想配列形式のZKPデータを、QRコード出力時に配列形式に変換してエンコードします。
  - QRコードのデータは、**バージョン番号、ZKP証明データ、ZKP公開入力** を含む最小限の構造とします。

#### 7. DIDドキュメントの構造

以下のJSON構造をDIDハッシュ生成のためのテンプレートとして使用します。

```json
{
  "@context": ["https://www.w3.org/ns/did/v1"],
  "verificationMethod": [
    {
      "type": "Ed25519VerificationKey2020",
      "publicKeyMultibase": "z<Base58BtcエンコードされたEd25519公開鍵>"
    }
  ],
  "authentication": ["#key-1"],
  "assertionMethod": ["#key-1"]
}
```

以下のJSON構造はDIDハッシュ生成後の完全なDIDドキュメントです。

```json
{
  "@context": ["https://www.w3.org/ns/did/v1"],
  "id": "did:amatelus:<DIDドキュメント全体のPQCハッシュ（SHA3-512模倣）>",
  "verificationMethod": [
    {
      "id": "did:amatelus:<DIDドキュメント全体のPQCハッシュ（SHA3-512模倣）>#key-1",
      "type": "Ed25519VerificationKey2020",
      "controller": "did:amatelus:<DIDドキュメント全体のPQCハッシュ（SHA3-512模倣）>",
      "publicKeyMultibase": "z<Base58BtcエンコードされたEd25519公開鍵>"
    }
  ],
  "authentication": ["#key-1"],
  "assertionMethod": ["#key-1"]
}
```

- `publicKeyMultibase` の値は、Ed25519公開鍵をBase58Btcでエンコードし、`z` 接頭辞を付けた形式とします。
- `id`, `verificationMethod.id`, `controller`, `authentication`, `assertionMethod` 内のDID文字列には、生成されたDIDドキュメント全体のSHA3-512ハッシュ値（PQCハッシュの模倣）が適切に埋め込まれるようにします。循環参照の解決ロジックを考慮してください。

#### 8. VCの内部構造（テンプレート例）

自治体から受け取るVCの構造は、以下のような形を想定します。

```json
{
  "@context": [
    "https://www.w3.org/2018/credentials/v1",
    "https://w3id.org/security/data-integrity/v1",
    "https://w3id.org/security/suites/eddsa-2022/v1"
  ],
  "id": "urn:uuid:<UUID v4>",
  "type": ["VerifiableCredential", "ResidentCredential"],
  "issuer": "did:amatelus:municipality_did_hash", // 発行者のDID
  "issuanceDate": "2025-06-25T10:00:00Z",
  "credentialSubject": {
    "id": "did:amatelus:citizen_did_hash", // 市民のアクティブなDID
    "familyName": "山田",
    "givenName": "太郎",
    "birthDate": "2000-01-01",
    "address": {
      "country": "日本",
      "postalCode": "187-0000",
      "region": "東京都",
      "locality": "小平市",
      "streetAddress": "〇〇町1丁目1番地"
    },
    "gender": "男性"
    // その他、住民票に含まれる情報
  },
  "proof": {
    "type": "DataIntegrityProof",
    "cryptosuite": "eddsa-rdfc-2022",
    "created": "2025-06-25T10:00:00Z",
    "verificationMethod": "key-1",
    "proofPurpose": "assertionMethod",
    "proofValue": "実際のBase64URLエンコードされた署名データ"
  }
}
```

### UI/UXの要件

- **DID選択UI:** 複数のDIDがある場合に、現在どのDIDがアクティブであるかを明確に表示し、他のDIDに切り替える操作が容易であること。
- **進捗表示:** ZKP生成、VC読み取りなどの時間のかかる処理中は、ユーザーに進捗を伝えるローディング表示やメッセージを表示。
- **QRコード表示/スキャン:**
  - 生成されたQRコードは、スマホの画面いっぱいに表示されるように配慮。
  - 読み取り用のQRコードスキャナーは、ユーザーが画面をタップして起動できるようにするか、特定のモードに入った際に自動でカメラを起動できるようにします。
  - VCの分割読み取り時、「読み取り済み N / 総パーツ数 M」といった進捗表示と、スキャン済みのパーツが正しく揃っているかの視覚的なフィードバックを提供します。

### 成果物

- `README.md` ファイル（プロジェクトのセットアップ方法、実行方法、各機能の説明、PoCにおける考慮事項・制約事項（特に`localStorage`利用やPQC模倣について）、および実装したフローの図解を記述）

### 補足事項

- バックエンドとの通信は行いません。VC発行やDID解決、Nonceの生成は、本アプリケーション内での模擬的な処理またはユーザーの手動入力/QRコード読み取りにとどめます。
- ZKPの証明検証ロジックは、この市民ウォレットPoCでは不要です（それは検証者側の責務であるため）。
- ZKP生成における計算時間計測は、ブラウザの`performance.now()`などを利用して実装してください。
